const fs = require('fs-extra');
const path = require('path');
const simpleGit = require('simple-git');
const axios = require('axios');
require('dotenv').config();

const WORKSPACE_ROOT = path.resolve(__dirname, '../../../');
const TEMPLATES_DIR = path.join(__dirname, '../templates');

// Project Ideas at Intersection of Stock Market & Tech
const IDEAS = [
  { name: 'ai-stock-predictor', desc: 'Predicts stock movements using LSTM models' },
  { name: 'crypto-sentiment-analyzer', desc: 'Analyzes social media sentiment for crypto' },
  { name: 'algo-trading-bot', desc: 'Automated trading bot using technical indicators' },
  { name: 'market-news-aggregator', desc: 'Aggregates and summarizes financial news' },
  { name: 'portfolio-optimizer', desc: 'Optimizes portfolio allocation using Modern Portfolio Theory' },
  { name: 'dividend-tracker', desc: 'Tracks dividend payouts and yields' },
  { name: 'options-pricing-calc', desc: 'Calculates options prices using Black-Scholes' },
  { name: 'technical-chart-visualizer', desc: 'Visualizes complex technical chart patterns' },
  { name: 'defi-yield-farming-dashboard', desc: 'Dashboard for tracking DeFi yields' },
  { name: 'nft-valuation-model', desc: 'Estimates value of NFTs based on rarity and sales' },
  // Cybersecurity Projects
  { name: 'packet-sniffer-pro', desc: 'Network traffic analyzer and packet sniffer' },
  { name: 'zero-trust-auth-system', desc: 'Demonstration of Zero Trust authentication architecture' },
  { name: 'iot-vulnerability-scanner', desc: 'Scans local IoT devices for common vulnerabilities' },
  { name: 'sql-injection-tester', desc: 'Automated tool to test web apps for SQLi vulnerabilities' },
  { name: 'blockchain-audit-tool', desc: 'Audits smart contracts for common security flaws' },
  { name: 'network-anomaly-detector', desc: 'Uses AI to detect unusual network traffic patterns' },
  { name: 'password-strength-analyser', desc: 'Advanced entropy-based password strength estimator' },
  { name: 'ransomware-simulation', desc: 'Safe simulation of ransomware behavior for educational purposes' },
  { name: 'secure-chat-protocol', desc: 'End-to-end encrypted chat protocol implementation' },
  { name: 'ddos-mitigation-sim', desc: 'Simulation of DDoS attack mitigation strategies' }
];

async function generateProject() {
  const randomIdea = IDEAS[Math.floor(Math.random() * IDEAS.length)];
  const uniqueName = `${randomIdea.name}-${Date.now()}`; // Ensure uniqueness
  const projectPath = path.join(WORKSPACE_ROOT, 'apps', uniqueName);

  console.log(`Generating project: ${uniqueName}...`);

  try {
    // 1. Create Project Directory
    await fs.ensureDir(projectPath);

    // 2. Initialize Basic Files
    const packageJson = {
      name: uniqueName,
      version: '1.0.0',
      description: randomIdea.desc,
      scripts: {
        "start": "node index.js",
        "enhance": "node daily-enhancer.js"
      },
      dependencies: {
        "axios": "^1.6.0",
        "moment": "^2.29.4"
      }
    };

    await fs.writeJson(path.join(projectPath, 'package.json'), packageJson, { indent: 2 });

    await fs.writeFile(path.join(projectPath, 'README.md'), `# ${uniqueName}\n\n${randomIdea.desc}\n\nAutomated project generated by Project Factory.`);

    await fs.writeFile(path.join(projectPath, 'index.js'), `console.log('Starting ${uniqueName}...');\n// TODO: Implement core logic`);

    // 3. Copy Enhancer Script
    const localEnhancerPath = path.join(__dirname, 'daily-enhancer.js');
    if (await fs.pathExists(localEnhancerPath)) {
      await fs.copy(localEnhancerPath, path.join(projectPath, 'daily-enhancer.js'));
    } else {
      // Write default enhancer if local file doesn't exist
      const defaultEnhancer = `
const fs = require('fs');
const path = require('path');

const LOG_FILE = path.join(__dirname, 'enhancement_log.txt');

function enhance() {
    const today = new Date().toISOString();
    const logEntry = '[' + today + '] Automated enhancement applied.\\n';
    
    fs.appendFileSync(LOG_FILE, logEntry);
    console.log('Project enhanced successfully.');
}

enhance();
`;
      await fs.writeFile(path.join(projectPath, 'daily-enhancer.js'), defaultEnhancer);
    }

    console.log(`Project ${uniqueName} created at ${projectPath}`);

  } catch (error) {
    console.error('Error generating project:', error);
  }
}

generateProject();
